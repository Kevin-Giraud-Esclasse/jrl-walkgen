<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Computing optimal weights for the preview control.</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('a00099.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Computing optimal weights for the preview control.</div>  </div>
</div><!--header-->
<div class="contents">
 First you need to include the header file: <div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;<a class="code" href="a00074.html">PreviewControl/OptimalControllerSolver.hh</a>&quot;</span>
</pre></div> In the following we will use a pointer towards an instance of class <a class="el" href="a00034.html" title="This class computes the gains for preview control for a given discrete system. The discrete system is...">OptimalControllerSolver</a>. <div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> main()
{
  <a class="code" href="a00034.html" title="This class computes the gains for preview control for a given discrete system. The discrete system is...">PatternGeneratorJRL::OptimalControllerSolver</a> *anOCS;
</pre></div> You have then to build the linear discrete system of the linear inverted pendulum such that: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} {\bf x}_{k+1} &amp;=&amp; {\bf A}{\bf x}_k + {\bf B} u_{k} \\ p_k &amp;=&amp; {\bf C} {\bf x}_{k} \\ \end{eqnarray*}" src="form_19.png"/>
</p>
<p>For this we need to declare the associated matrices: <div class="fragment"><pre class="fragment">  <span class="comment">/* Declare the linear system */</span>
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#a1ecb2d43e5d380623ea2c56d5eaa693a">MAL_MATRIX_DIM</a>(A,<span class="keywordtype">double</span>,3,3);
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#a1ecb2d43e5d380623ea2c56d5eaa693a">MAL_MATRIX_DIM</a>(<a class="code" href="a00087.html#a3a777cb7a80ce20d71f55f674cdc692c">b</a>,<span class="keywordtype">double</span>,3,1);
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#a1ecb2d43e5d380623ea2c56d5eaa693a">MAL_MATRIX_DIM</a>(<a class="code" href="a00087.html#a802c8c65d02147b186949e9da316bf45">c</a>,<span class="keywordtype">double</span>,1,3);
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#abb9ee339d9c77871de9c0efc6fffa09c">MAL_MATRIX_TYPE</a>( <span class="keywordtype">double</span>) lF;
</pre></div> and the weights of the function to be minimized: <div class="fragment"><pre class="fragment">  <span class="keywordtype">double</span> Q, R;
  <span class="keywordtype">int</span> Nl;
  <span class="keywordtype">double</span> T = 0.005;
</pre></div></p>
<p>Then we have to initialize the discretized linear system with</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} {\bf A} &amp; \equiv &amp; \left[ \begin{matrix} 1 &amp; T &amp; T^2/2 \\ 0 &amp; 1 &amp; T \\ 0 &amp; 0 &amp; 1 \end{matrix} \right] \\ {\bf B} &amp; \equiv &amp; \left[ \begin{matrix} T^3/6 \\ T^2/2 \\ T \end{matrix} \right] \\ {\bf C} &amp; \equiv &amp; \left[ 1 \; 0 \; \frac{-z_c}{g} \right] \end{eqnarray*}" src="form_20.png"/>
</p>
<p> <div class="fragment"><pre class="fragment">  <span class="comment">/* Build the initial discrete system</span>
<span class="comment">     regarding the CoM and the ZMP. */</span>
  A(0,0) = 1.0; A(0,1) =   T; A(0,2) = T*T/2.0;
  A(1,0) = 0.0; A(1,1) = 1.0; A(1,2) = T;
  A(2,0) = 0.0; A(2,1) = 0.0; A(2,2) = 1;

  <a class="code" href="a00087.html#a3a777cb7a80ce20d71f55f674cdc692c">b</a>(0,0) = T*T*T/6.0;
  <a class="code" href="a00087.html#a3a777cb7a80ce20d71f55f674cdc692c">b</a>(1,0) = T*T/2.0;
  <a class="code" href="a00087.html#a3a777cb7a80ce20d71f55f674cdc692c">b</a>(2,0) = T;

  <a class="code" href="a00087.html#a802c8c65d02147b186949e9da316bf45">c</a>(0,0) = 1.0;
  <a class="code" href="a00087.html#a802c8c65d02147b186949e9da316bf45">c</a>(0,1) = 0.0;
  <a class="code" href="a00087.html#a802c8c65d02147b186949e9da316bf45">c</a>(0,2) = -0.814/9.8;
</pre></div></p>
<p>We then have to initialize the weights of the index function: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ J = \sum^{NL}_{j=1} \{ Q(p^{ref}_j -p_j)^2 + Ru_j^2 \} \]" src="form_21.png"/>
</p>
<p><div class="fragment"><pre class="fragment">  Q = 1.0;
  R = 1e-6;

  Nl = (int)(1.6/T);
</pre></div></p>
<p>To suppress the problem of the initial CoM position, we can reformulate the discrete problem by posing the following: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} {\bf x}^*_{k+1} = \widetilde{\bf A} {\bf x}^*_{k} + \widetilde{\bf b}\Delta u_k p_k = \widetilde{\bf c}{\bf x}^*_{k} \end{eqnarray*}" src="form_22.png"/>
</p>
<p> with {eqnarray*  u_k  u_k - u_{k-1} &amp;  { x}_k  { x}_k - { x}_{k-1} { x}_k  [ {matrix} p_k\  { x}_k {matrix} ] }</p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\begin{eqnarray*} \widetilde{\bf A} &amp;\equiv &amp; \left[ \begin{matrix} 1 &amp; {\bf cA} \\ {\bf 0} &amp; {\bf A} \\ \end{matrix} \right] \\ \tilde{\bf b} &amp; \equiv &amp; \left[ \begin{matrix} {\bf cb} \\ {\bf c} \end{matrix} \right] \\ \tilde{\bf c} &amp; \equiv &amp; [ 1 \; 0 \; 0 \; 0] \\ \end{eqnarray*}" src="form_15.png"/>
</p>
<p>Then the subsequent code performs this operation and displays the associated matrices: <div class="fragment"><pre class="fragment">  <span class="comment">// Build the derivated system</span>
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#a1ecb2d43e5d380623ea2c56d5eaa693a">MAL_MATRIX_DIM</a>(Ax,<span class="keywordtype">double</span>,4,4);
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#a32647b9ffc55fcade27dd54bf1c85495">MAL_MATRIX</a>(tmpA,<span class="keywordtype">double</span>);
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#a1ecb2d43e5d380623ea2c56d5eaa693a">MAL_MATRIX_DIM</a>(bx,<span class="keywordtype">double</span>,4,1);
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#a32647b9ffc55fcade27dd54bf1c85495">MAL_MATRIX</a>(tmpb,<span class="keywordtype">double</span>);
  <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#a1ecb2d43e5d380623ea2c56d5eaa693a">MAL_MATRIX_DIM</a>(cx,<span class="keywordtype">double</span>,1,4);
  
  tmpA = <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#ada73b0370275a533dc31d335cd1ac4cf">MAL_RET_A_by_B</a>(<a class="code" href="a00087.html#a802c8c65d02147b186949e9da316bf45">c</a>,A);
  cout &lt;&lt; <span class="stringliteral">&quot;tmpA :&quot;</span> &lt;&lt; tmpA&lt;&lt;endl;

  Ax(0,0)= 1.0;
  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;3;i++)
    {
      Ax(0,i+1) = tmpA(0,i);
    Ax(i+1,0) = 0.;
      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;3;j++)
  Ax(i+1,j+1) = A(i,j);
    }
  cout &lt;&lt; <span class="stringliteral">&quot;Ax: &quot;</span> &lt;&lt; endl &lt;&lt; Ax&lt;&lt; endl;

  tmpb = <a class="codeRef" doxygen="jrl-mal.doxytag:" href="a00022.html#ada73b0370275a533dc31d335cd1ac4cf">MAL_RET_A_by_B</a>(<a class="code" href="a00087.html#a802c8c65d02147b186949e9da316bf45">c</a>,<a class="code" href="a00087.html#a3a777cb7a80ce20d71f55f674cdc692c">b</a>);
  bx(0,0) = tmpb(0,0);
  <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;3;i++)
    {
      bx(i+1,0) = <a class="code" href="a00087.html#a3a777cb7a80ce20d71f55f674cdc692c">b</a>(i,0);
    }

  cout &lt;&lt; <span class="stringliteral">&quot;bx: &quot;</span> &lt;&lt; endl &lt;&lt; bx &lt;&lt; endl;

  cx(0,0) =1.0;   
  cx(0,1) =0.0;
  cx(0,2) =0.0;
  cx(0,3) =0.0;
  cout &lt;&lt; <span class="stringliteral">&quot;cx: &quot;</span> &lt;&lt; endl &lt;&lt; cx &lt;&lt; endl;
</pre></div></p>
<p>To create the instance of the object solving the Riccati Equation: <div class="fragment"><pre class="fragment">  anOCS = <span class="keyword">new</span> <a class="code" href="a00034.html" title="This class computes the gains for preview control for a given discrete system. The discrete system is...">PatternGeneratorJRL::OptimalControllerSolver</a>(Ax,bx,cx,Q,R,Nl);
</pre></div></p>
<p>The computation of the weights is done by calling ComputeWeights(). There is only one parameter to specify, but it is important as the weights are computed differently according to this parameter. If you use the mode without initial position please uses MODE_WITH_INITIALPOS. <div class="fragment"><pre class="fragment">  anOCS-&gt;<a class="code" href="a00034.html#aee54d2c044c1065df3ec0929642732f7">ComputeWeights</a>(<a class="code" href="a00034.html#a14c8ec61ff695be1e0bc094ae9590ef1">PatternGeneratorJRL::OptimalControllerSolver::MODE_WITHOUT_INITIALPOS</a>);
</pre></div></p>
<p>To display the weights in the standard output <div class="fragment"><pre class="fragment">  anOCS-&gt;<a class="code" href="a00034.html#a0ccca631b5d083beef0702de09565d9f">DisplayWeights</a>();
</pre></div></p>
<p>It is possible to retrieve the weights in a vector: <div class="fragment"><pre class="fragment">  anOCS-&gt;<a class="code" href="a00034.html#a14b9e21f00f0f430e3e42474d340866c">GetF</a>(lF);
</pre></div> To compute the same weight with a specific initial position and the original linear system you can use : <div class="fragment"><pre class="fragment">  anOCS = <span class="keyword">new</span> <a class="code" href="a00034.html" title="This class computes the gains for preview control for a given discrete system. The discrete system is...">PatternGeneratorJRL::OptimalControllerSolver</a>(A,<a class="code" href="a00087.html#a3a777cb7a80ce20d71f55f674cdc692c">b</a>,<a class="code" href="a00087.html#a802c8c65d02147b186949e9da316bf45">c</a>,Q,R,Nl);

  anOCS-&gt;<a class="code" href="a00034.html#aee54d2c044c1065df3ec0929642732f7">ComputeWeights</a>(<a class="code" href="a00034.html#a282baa9cd219b86fee53ed8fa60ba549">PatternGeneratorJRL::OptimalControllerSolver::MODE_WITH_INITIALPOS</a>);
</pre></div> </p>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div>
  <div id="nav-path" class="navpath">
    <ul>
</body>
</html>
